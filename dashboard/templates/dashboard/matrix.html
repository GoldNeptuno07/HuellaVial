{% extends 'dashboard/base.html' %}
{% load impact_filters %}

{% block title %}{{ project.name }}{% endblock %}

{% block nav-links %}
    <a class="nav-link dropdown-toggle fw-semibold" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        Fases del Projecto
    </a>
    <ul class="dropdown-menu">
        {% for p in phases %}
            <li><a class="dropdown-item" href="{% url 'dashboard:impact-matrix' project_id=project.id phase_name=p.name %}">{{ p.name|upper }}</a></li>
        {% endfor %}
    </ul>

    <a class="nav-link fw-semibold" href="#">Agregar</a>
    <a class="nav-link fw-semibold" href="#">Remover</a>
    <a class="nav-link fw-semibold" href="#">Ayuda</a>
    <a class="nav-link fw-semibold" href="#">Salir</a>
{% endblock %}


{% block content %}
    <div class="container-xl">
        <table class="table">
        <thead>
            <tr>
                <th scope="row" rowspan="2" colspan="2"></th>
                <th colspan="{{ phase.operations.count }}" style="background-color: orange;" class="text-center">{{ phase.name|upper }}</th>
                <th></th>
                <th colspan= "6" style="background-color: green;" class="text-center">CALIFICACION</th>
                <th></th>
            </tr>
            <tr>
                {% for operation in phase.operations.all %}
                 <th class="rotate"><div><span>{{ operation.name|upper }}</span></div></th>
                {% endfor %}
                <th class="text-center fs-10 text-center align-middle">DESCRIPCION DEL IMPACTO AMBIENTAL IDENTIFICADO</th>
                <th class="rotate"><div>INTENSIDAD</div></th>
                <th class="rotate"><div>IMPORTANCIA</div></th>
                <th class="rotate"><div>EXTENSION</div></th>
                <th class="rotate"><div>PERSISTENCIA</div></th>
                <th class="rotate"><div>REVERSIBILIDAD</div></th>
                <th class="rotate"><div>TOTAL</div></th>
                <th class="text-center align-middle">Impacto Significativo</th>
            </tr>
        </thead>
        <tbody>
            <!-- Matrix content -->
            {% for resource_obj in resources %}
                {% for subresource_obj in resource_obj.subresources.all %}
                <tr>
                    <!-- Impacts Section (Left Side) -->
                    {% if forloop.first %}
                    <th scope="row" rowspan="{{ resource_obj.subresources.count }}" class="text-center align-middle">
                        {{ resource_obj.name }}
                    </th>
                    {% endif %}
                    
                    <td class="text-center align-middle">{{ subresource_obj.name }}</td>
                    
                    {% for operation_obj in phase.operations.all %}
                        {% with marked=operation_obj|is_marked:subresource_obj %}
                        <td class="impact-cell text-center border align-middle"
                            data-operation="{{ operation_obj.id }}"
                            data-subresource="{{ subresource_obj.id }}">
                            {% if marked %}X{% endif %}
                        </td>
                        {% endwith %}
                    {% endfor %}

                    <!-- Ratings Section (Right Side) -->
                    {% with rating=phase|get_rating:subresource_obj %}
                        <!-- Description -->
                        <td class="text-center border align-middle">
                            {{ rating.description }}
                        </td>
                        <!-- Intensity -->
                        <td class="text-center border align-middle"
                            data-phase="{{ phase.id }}"
                            data-subresource="{{ subresource_obj.id }}">
                            {{ rating.intensity }}
                        </td>
                        <!-- Importance -->
                        <td class="text-center border align-middle"
                            data-phase="{{ phase.id }}"
                            data-subresource="{{ subresource_obj.id }}">
                            {{ rating.importance }}
                        </td>
                        <!-- Extension -->
                        <td class="text-center border align-middle"
                            data-phase="{{ phase.id }}"
                            data-subresource="{{ subresource_obj.id }}">
                            {{ rating.extension }}
                        </td>
                        <!-- Persistence -->
                        <td class="text-center border align-middle"
                            data-phase="{{ phase.id }}"
                            data-subresource="{{ subresource_obj.id }}">
                            {{ rating.persistence }}
                        </td>
                        <!-- Reversibility -->
                        <td class="text-center border align-middle"
                            data-phase="{{ phase.id }}"
                            data-subresource="{{ subresource_obj.id }}">
                            {{ rating.reversibility }}
                        </td>
                        <!-- Total -->
                        <td class="text-center border align-middle">20</td>
                        <!-- Significant Impact -->
                        <td class="text-center border align-middle">NO</td>
                    {% endwith %}
                    </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
        </table>
    </div>
{% endblock %}

{% block js %}
    <script>
        document.querySelectorAll('.impact-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                const operationId = this.dataset.operation;
                const subresourceId = this.dataset.subresource;
                
                fetch('{% url "dashboard:toggle_impact" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `operation_id=${operationId}&subresource_id=${subresourceId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        this.classList.toggle('marked', data.is_marked);
                        this.innerHTML = data.is_marked ? 'X' : '';
                    }
                });
            });
        });
    </script>
{% endblock %}