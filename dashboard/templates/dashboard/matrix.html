{% extends 'dashboard/base.html' %}
{% load impact_filters %}

{% block title %}{{ project.name }}{% endblock %}

{% block nav-links %}
    <a class="nav-link dropdown-toggle fw-semibold" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        Fases del Projecto
    </a>
    <ul class="dropdown-menu">
        {% for p in phases %}
            <li><a class="dropdown-item" href="{% url 'dashboard:impact-matrix' project_id=project.id phase_name=p.name %}">{{ p.name|upper }}</a></li>
        {% endfor %}
    </ul>

    <a class="nav-link fw-semibold" href="#">Agregar</a>
    <a class="nav-link fw-semibold" href="#">Remover</a>
    <a class="nav-link fw-semibold" href="#">Ayuda</a>
    <a class="nav-link fw-semibold" href="#">Salir</a>
{% endblock %}


{% block content %}
    <div class="container-xl">
        <table class="table">
        <thead>
            <tr>
                <th scope="row" rowspan="2" colspan="2"></th>
                <th colspan="{{ phase.operations.count }}" style="background-color: orange;" class="text-center">{{ phase.name|upper }}</th>
                <th></th>
                <th colspan= "6" style="background-color: green;" class="text-center">CALIFICACION</th>
                <th></th>
            </tr>
            <tr>
                {% for operation in phase.operations.all %}
                 <th class="rotate"><div><span>{{ operation.name|upper }}</span></div></th>
                {% endfor %}
                <th class="text-center fs-10 text-center align-middle">DESCRIPCION DEL IMPACTO AMBIENTAL IDENTIFICADO</th>
                <th class="rotate"><div>INTENSIDAD</div></th>
                <th class="rotate"><div>IMPORTANCIA</div></th>
                <th class="rotate"><div>EXTENSION</div></th>
                <th class="rotate"><div>PERSISTENCIA</div></th>
                <th class="rotate"><div>REVERSIBILIDAD</div></th>
                <th class="rotate"><div>TOTAL</div></th>
                <th class="text-center align-middle">Impacto Significativo</th>
            </tr>
        </thead>
        <tbody>
            <!-- Matrix content -->
            {% for resource_obj in resources %}
                {% for subresource_obj in resource_obj.subresources.all %}
                <tr>
                    <!-- Impacts Section (Left Side) -->
                    {% if forloop.first %}
                    <th scope="row" rowspan="{{ resource_obj.subresources.count }}" class="text-center align-middle">
                        {{ resource_obj.name }}
                    </th>
                    {% endif %}
                    
                    <td class="text-center align-middle">{{ subresource_obj.name }}</td>
                    
                    {% for operation_obj in phase.operations.all %}
                        {% with marked=operation_obj|is_marked:subresource_obj %}
                        <td class="impact-cell text-center border align-middle"
                            data-operation="{{ operation_obj.id }}"
                            data-subresource="{{ subresource_obj.id }}">
                            {% if marked %}X{% endif %}
                        </td>
                        {% endwith %}
                    {% endfor %}

                    <!-- Ratings Section (Right Side) -->
                    {% with rating=phase|get_rating:subresource_obj %}
                        {% if rating %}
                            <!-- Description -->
                            <td class="text-center border align-middle">{{ rating.description }}</td>
                            <form>
                                {% csrf_token %}
                                <!-- Intensity -->
                                <td>
                                    <select name="intensity" class="form-input text-center rating-cell" data-raiting-id="{{ rating.id }}" onchange="updateTotal(this)">
                                        {% for value, label in rating.rating_scale.choices %}
                                            <option value="{{ value }}" {% if value == rating.intensity %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <!-- Importance -->
                                <td>
                                    <select name="importance" class="form-input text-center rating-cell" data-raiting-id="{{ rating.id }}" onchange="updateTotal(this)">
                                        {% for value, label in rating.rating_scale.choices %}
                                            <option value="{{ value }}" {% if value == rating.importance %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <!-- Extension -->
                                <td>
                                    <select name="extension" class="form-input text-center rating-cell" data-raiting-id="{{ rating.id }}" onchange="updateTotal(this)">
                                        {% for value, label in rating.rating_scale.choices %}
                                            <option value="{{ value }}" {% if value == rating.extension %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <!-- Persistence -->
                                <td>
                                    <select name="persistence" class="form-input text-center rating-cell" data-raiting-id="{{ rating.id }}" onchange="updateTotal(this)">
                                        {% for value, label in rating.rating_scale.choices %}
                                            <option value="{{ value }}" {% if value == rating.persistence %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <!-- Reversibility -->
                                <td>
                                    <select name="reversibility" class="form-input text-center rating-cell" data-raiting-id="{{ rating.id }}" onchange="updateTotal(this)">
                                        {% for value, label in rating.rating_scale.choices %}
                                            <option value="{{ value }}" {% if value == rating.reversibility %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <!-- Total Sum Column -->
                                <td name="total" class="text-center border align-middle total-cell" id="total-{{ rating.id }}">
                                    {{ rating.intensity|add:rating.importance|add:rating.extension|add:rating.persistence|add:rating.reversibility }}
                                </td>

                                <!-- Significant Impact -->
                                 <td class="text-center border align-middle" id="significant-{{ rating.id }}">
                                    <!-- Filled with JS -->
                                 </td>
                            </form>
                        {% else %}
                            <!-- Handle missing rating (optional) -->
                            <td colspan="7" class="text-center text-muted">No rating available</td>
                        {% endif %}
                    {% endwith %}
                </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
        </table>
    </div>
{% endblock %}

{% block js %}
    <script>
        document.querySelectorAll('.impact-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                const operationId = this.dataset.operation;
                const subresourceId = this.dataset.subresource;
                
                fetch('{% url "dashboard:toggle_impact" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `operation_id=${operationId}&subresource_id=${subresourceId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        this.classList.toggle('marked', data.is_marked);
                        this.innerHTML = data.is_marked ? 'X' : '';
                    }
                });
            });
        });
        
        document.querySelectorAll('.rating-cell').forEach(cell => {
            cell.addEventListener('change', function() {
                const ratingId = this.dataset.raitingId;
                const field = this.name;
                const value = this.value;

                fetch(`/dashboard/update_rating/${ratingId}/`, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `field=${field}&value=${value}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Success')
                    }
                })
            });
        });

        function updateTotal(selectElement) {
            const row = selectElement.closest('tr');
            const ratingId = selectElement.getAttribute('data-raiting-id');
            const totalCell = document.getElementById(`total-${ratingId}`);
            
            // Get all select values and sum them
            const intensity = parseInt(row.querySelector('[name="intensity"]').value) || 0;
            const importance = parseInt(row.querySelector('[name="importance"]').value) || 0;
            const extension = parseInt(row.querySelector('[name="extension"]').value) || 0;
            const persistence = parseInt(row.querySelector('[name="persistence"]').value) || 0;
            const reversibility = parseInt(row.querySelector('[name="reversibility"]').value) || 0;
            
            const total = intensity + importance + extension + persistence + reversibility;
            totalCell.textContent = total;

            // Update "Impacto Significativo" for this row
            updateSignificantImpact();
        }

        function calculateMeanTotal() {
            const totalCells = document.querySelectorAll('.total-cell');
            let sum = 0;
            let count = 0;

            totalCells.forEach(cell => {
                const value = parseInt(cell.textContent) || 0;
                sum += value;
                count++;
            });

            return count > 0 ? sum / count : 0;
        }

        function updateSignificantImpact() {
            const mean = calculateMeanTotal();
            const totalCells = document.querySelectorAll('.total-cell');

            totalCells.forEach(cell => {
                const ratingId = cell.id.split('-')[1];
                const significantCell = document.getElementById(`significant-${ratingId}`);
                const total = parseInt(cell.textContent) || 0;

                if (significantCell) {
                    significantCell.textContent = total > mean ? 'Yes' : 'No';
                    // Optional: Add styling (e.g., color)
                    significantCell.style.color = total > mean ? 'red' : 'green';
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Update totals for all rows
            document.querySelectorAll('.rating-cell').forEach(cell => {
                updateTotal(cell);
            });

            // Calculate and apply "Impacto Significativo"
            updateSignificantImpact();
        });
        
    </script>
{% endblock %}